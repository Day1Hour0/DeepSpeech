version: 1
policy:
  pullRequests: public
tasks:
  $match:
    # Decision task for pull requests
    'tasks_for == "github-pull-request" && event["action"] in ["opened", "reopened", "synchronize"]':
      taskId: {$eval: as_slugid("decision_task")}
      created: {$fromNow: ''}
      deadline: {$fromNow: '60 minutes'}

      provisionerId: "proj-deepspeech"
      workerType: "ci-decision-task"

      scopes: [
        "queue:create-task:highest:proj-deepspeech/*",
        "queue:route:index.project.deepspeech.*",
        "index:insert-task:project.deepspeech.*",
        "queue:scheduler-id:taskcluster-github",
        "generic-worker:cache:deepspeech-macos-pyenv",
        "docker-worker:capability:device:kvm"
      ]

      payload:
        maxRunTime: 600
        image: "ubuntu:16.04"

        features:
          taskclusterProxy: true

        env:
          TC_DECISION_SHA: ef67832e6657f43e139a10f37eb326a7d9d96dad

        command:
          - "/bin/bash"
          - "--login"
          - "-cxe"
          - >
            echo "deb http://archive.ubuntu.com/ubuntu/ xenial-updates main" > /etc/apt/sources.list.d/xenial-updates.list &&
            apt-get -qq update && apt-get -qq -y install git python3-pip curl sudo &&
            adduser --system --home /home/build-user build-user &&
            cd /home/build-user/ &&
            echo -e "#!/bin/bash\nset -xe\nenv && id && mkdir ~/DeepSpeech/ && git clone --quiet ${event.pull_request.head.repo.clone_url} ~/DeepSpeech/ds/ && cd ~/DeepSpeech/ds && git checkout --quiet {{event.head.sha}}" > /tmp/clone.sh && chmod +x /tmp/clone.sh &&
            sudo -H -u build-user /bin/bash /tmp/clone.sh &&
            sudo -H -u build-user --preserve-env /bin/bash /home/build-user/DeepSpeech/ds/taskcluster/tc-schedule.sh \
              TASK_ID={$eval: as_slugid("decision_task")}
              GITHUB_HEAD_USER_LOGIN=${event.pull_request.user.login} \
              GITHUB_EVENT=${event.action} \
              GITHUB_HEAD_REPO_URL=${event.pull_request.head.repo.clone_url} \
              GITHUB_HEAD_BRANCH=${event.pull_request.head.ref} \
              GITHUB_HEAD_REF=${event.pull_request.head.ref} \
              GITHUB_HEAD_SHA=${event.pull_request.head.ref}
        artifacts:
          "public":
            type: "directory"
            path: "/tmp/artifacts/"
            expires: "{{ '7 days' | $fromNow }}"

      metadata:
        name: "DeepSpeech PR decision task"
        description: "DeepSpeech PR decision task"
        owner: "${event.pull_request.user.login}@users.noreply.github.com" # the user who sent the pr
        source: "${event.repository.url}" # the repo where the pr came from will be inserted here

    # Decision task for pushes to master
    'tasks_for == "github-push" && event.ref == "refs/heads/master"':
      taskId: {$eval: as_slugid("decision_task")}
      created: {$fromNow: ''}
      deadline: {$fromNow: '60 minutes'}

      provisionerId: "proj-deepspeech"
      workerType: "ci-decision-task"

      scopes: [
        "queue:create-task:highest:proj-deepspeech/*",
        "queue:route:index.project.deepspeech.*",
        "index:insert-task:project.deepspeech.*",
        "queue:scheduler-id:taskcluster-github",
        "generic-worker:cache:deepspeech-macos-pyenv",
        "docker-worker:capability:device:kvm"
      ]

      payload:
        maxRunTime: 600
        image: "ubuntu:16.04"

        features:
          taskclusterProxy: true

        env:
          TC_DECISION_SHA: ef67832e6657f43e139a10f37eb326a7d9d96dad

        command:
          - "/bin/bash"
          - "--login"
          - "-cxe"
          - >
            echo "deb http://archive.ubuntu.com/ubuntu/ xenial-updates main" > /etc/apt/sources.list.d/xenial-updates.list &&
            apt-get -qq update && apt-get -qq -y install git python3-pip curl sudo &&
            adduser --system --home /home/build-user build-user &&
            cd /home/build-user/ &&
            echo -e "#!/bin/bash\nset -xe\nenv && id && mkdir ~/DeepSpeech/ && git clone --quiet {{event.head.repo.url}} ~/DeepSpeech/ds/ && cd ~/DeepSpeech/ds && git checkout --quiet {{event.head.sha}}" > /tmp/clone.sh && chmod +x /tmp/clone.sh &&
            sudo -H -u build-user /bin/bash /tmp/clone.sh &&
            sudo -H -u build-user --preserve-env /bin/bash /home/build-user/DeepSpeech/ds/taskcluster/tc-schedule.sh \
              TASK_ID={$eval: as_slugid("decision_task")} \
              GITHUB_HEAD_USER_LOGIN=${event.pusher.name} \
              GITHUB_EVENT=${event.action} \
              GITHUB_HEAD_REPO_URL=${event.repository.clone_url} \
              GITHUB_HEAD_BRANCH=${event.ref} \
              GITHUB_HEAD_REF=${event.ref} \
              GITHUB_HEAD_SHA=${event.ref}
        artifacts:
          "public":
            type: "directory"
            path: "/tmp/artifacts/"
            expires: "{{ '7 days' | $fromNow }}"
      metadata:
        name: "DeepSpeech push decision task"
        description: "DeepSpeech push decision task"
        owner: "${event.pusher.name}@users.noreply.github.com" # the user who sent the push e-mail will be inserted here
        source: "${event.repository.url}" # the repo where the push came from will be inserted here

    # Decision task for tag push
    'tasks_for == "github-push" && event.ref[:10] == "refs/tags/"':
      taskId: {$eval: as_slugid("decision_task")}
      created: {$fromNow: ''}
      deadline: {$fromNow: '60 minutes'}

      provisionerId: "proj-deepspeech"
      workerType: "ci-decision-task"

      scopes: [
        "queue:create-task:highest:proj-deepspeech/*",
        "queue:route:index.project.deepspeech.*",
        "index:insert-task:project.deepspeech.*",
        "queue:scheduler-id:taskcluster-github",
        "generic-worker:cache:deepspeech-macos-pyenv",
        "docker-worker:capability:device:kvm"
      ]

      payload:
        maxRunTime: 600
        image: "ubuntu:16.04"

        features:
          taskclusterProxy: true

        env:
          TC_DECISION_SHA: ef67832e6657f43e139a10f37eb326a7d9d96dad

        command:
          - "/bin/bash"
          - "--login"
          - "-cxe"
          - >
            echo "deb http://archive.ubuntu.com/ubuntu/ xenial-updates main" > /etc/apt/sources.list.d/xenial-updates.list &&
            apt-get -qq update && apt-get -qq -y install git python3-pip curl sudo &&
            adduser --system --home /home/build-user build-user &&
            cd /home/build-user/ &&
            echo -e "#!/bin/bash\nset -xe\nenv && id && mkdir ~/DeepSpeech/ && git clone --quiet {{event.head.repo.url}} ~/DeepSpeech/ds/ && cd ~/DeepSpeech/ds && git checkout --quiet {{event.head.sha}}" > /tmp/clone.sh && chmod +x /tmp/clone.sh &&
            sudo -H -u build-user /bin/bash /tmp/clone.sh &&
            sudo -H -u build-user --preserve-env /bin/bash /home/build-user/DeepSpeech/ds/taskcluster/tc-schedule.sh \
              TASK_ID={$eval: as_slugid("decision_task")} \
              GITHUB_HEAD_USER_LOGIN=${event.pusher.name} \
              GITHUB_EVENT=${event.action} \
              GITHUB_HEAD_REPO_URL=${event.repository.clone_url} \
              GITHUB_HEAD_TAG=${event.ref[10:]} \
              GITHUB_HEAD_REF=${event.ref} \
              GITHUB_HEAD_SHA=${event.ref}
        artifacts:
          "public":
            type: "directory"
            path: "/tmp/artifacts/"
            expires: "{{ '7 days' | $fromNow }}"
      metadata:
        name: "DeepSpeech push decision task"
        description: "DeepSpeech push decision task"
        owner: "${event.pusher.name}@users.noreply.github.com" # the user who sent the push e-mail will be inserted here
        source: "${event.repository.url}" # the repo where the push came from will be inserted here
